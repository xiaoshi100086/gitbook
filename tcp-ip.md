# TCP/IP

## IP 数据包的大小限制

IP报文头有长度字段为2个字节，所以理论限制是65535。但实际上，ip报文段会根据设备的MTU进行切片。

### MTU

最大传输单元（Maximum transmission unit，即 MTU），MTU 是 IP 数据包能够传输的数据上限。

每个网络设备都有一个固定的MTU，其中包括网络两端的主机以及链路上的路由器。两个主机的MTU由两主机间网络的设备最小的MTU决定。准确来说，组件可以通过ICMP协议来获取某个链路上的最小MTU，进而通过该MTU来限制IP数据包的大小；否则链路上网络设备接受过大的数据包，会自动进行 _数据包分片 ，_依次进行发送。

一般网络设备的MTU是1500，减去IP包头20字节长度，最大数据为1480

### 数据包分片

数据包分片对上层透明，并且分片的数据包可以再进行分片。分片后的数据包有相同的IP报文头，除了报文头的偏移字段不同。相同的报文头的数据包会在目的地进行分片重组。

IP协议是不可靠的，如果分片的报文头丢弃，则重组则会失败，会丢弃重组中的所有数据包

#### IP分片缺点

IP分片有些如下缺点，所以传输层都会避免IP分片

* 分片和重组都需要占用CPU和内存，对路由器而言，这两种资源都比较紧张
* 一个分片丢失，则所有分片都需要会被丢弃
* 只有等待所有分片都接受了才能进行重组，增大了耗时

#### TCP如何避免IP分片

tcp使用MSS（Maximum segment size，最大报文段大小，是 MTU-IP报文头长度20字节-TCP报文头长度20字节）来避免IP分片。

在三次握手时，会交换双方的MSS（一般是1460），并使用最小的MSS限制报文段的长度。

但链路上的网络设备的MTU可能比较低，当IP数据包发送到该网络设备还是会进行IP切分。一般系统会设置PMTUD（Path MTU Discovery），该设置会禁用IP分片，当IP数据报文发送到小MTU网络设备时，会直接丢弃，并通过ICMP返回该网络设备的MTU，系统会根据该值来重设MSS。

#### UDP如何避免IP分片

UDP没有很好的规避手段，但一般网络设备的MTU为1500，所以一般会设置UDP报文段大小为1472（1500-IP报文头长度20-UDP报文头长度8）来尽量避免

## TCP数据段的大小限制

TCP的数据段大小受到MTU的限制，所以一般最大为1480。

最小长度为TCP报文头长度20。但注意TCP是流式传输，所以应用层不能发送长度为0的流式数据（TCP控制报文基本都是长度为0的报文），所以应用层触发的TCP最小长度为21。

## UDP数据段的大小限制

UDP的报文头长度为两个字节，所以数据段最大大小为65535。但一般会采用1480的长度限制来避免IP分包。

UDP报文头的最小长度为UDP报文头8。
